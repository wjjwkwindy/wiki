
# æ€»ç»“äº†å¼€å‘ç§å¸¸è§çš„å‡ ç§è·¨åŸŸæ–¹æ³•ã€‚

Demoåœ°å€: <a href="https://github.com/FatDong1/cross-origin">https://github.com/FatDong1/cross-origin</a>


## Qï¼šä¸ºä»€ä¹ˆä¼šå‡ºç°è·¨åŸŸ

å‡ºäºæµè§ˆå™¨çš„åŒæºç­–ç•¥é™åˆ¶ï¼Œæµè§ˆå™¨ä¼šæ‹’ç»è·¨åŸŸè¯·æ±‚ã€‚

*æ³¨ï¼šä¸¥æ ¼çš„è¯´ï¼Œæµè§ˆå™¨å¹¶ä¸æ˜¯æ‹’ç»æ‰€æœ‰çš„è·¨åŸŸè¯·æ±‚ï¼Œå®é™…ä¸Šæ‹’ç»çš„æ˜¯è·¨åŸŸçš„è¯»æ“ä½œã€‚æµè§ˆå™¨çš„åŒæºé™åˆ¶ç­–ç•¥æ˜¯è¿™æ ·æ‰§è¡Œçš„ï¼š*

é€šå¸¸æµè§ˆå™¨å…è®¸è¿›è¡Œè·¨åŸŸå†™æ“ä½œï¼ˆCross-origin writesï¼‰ï¼Œå¦‚é“¾æ¥ï¼Œé‡å®šå‘ï¼›
é€šå¸¸æµè§ˆå™¨å…è®¸è·¨åŸŸèµ„æºåµŒå…¥ï¼ˆCross-origin embeddingï¼‰ï¼Œå¦‚ imgã€script æ ‡ç­¾ï¼›
**é€šå¸¸æµè§ˆå™¨ä¸å…è®¸è·¨åŸŸè¯»æ“ä½œï¼ˆCross-origin readsï¼‰ã€‚**

## Qï¼šä»€ä¹ˆæƒ…å†µä¸‹ç®—è·¨åŸŸ

éåŒæºè¯·æ±‚ï¼Œå‡ä¸ºè·¨åŸŸã€‚
åè¯è§£é‡Šï¼šåŒæº â€”â€” å¦‚æœä¸¤ä¸ªé¡µé¢æ‹¥æœ‰ç›¸åŒçš„åè®®ï¼ˆprotocolï¼‰ï¼Œç«¯å£ï¼ˆportï¼‰å’Œä¸»æœºï¼ˆhostï¼‰ï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªé¡µé¢å°±å±äºåŒä¸€ä¸ªæºï¼ˆoriginï¼‰ã€‚

|ä¸»æœºURLï¼šhttp://www.example.com   | æ˜¯å¦è·¨åŸŸ |  åŸå›                   |
|--------------------------------|:--------:|:-----------------------|
|http://www.example.com/a.html     |å¦        | åŒæº                   |
|https://www.example.com/a.html    |æ˜¯        | åè®®ä¸åŒ               |
|http://www.example.com:8080/a.html|æ˜¯        | ç«¯å£ä¸åŒ               |
|http://example.com/a.html         |æ˜¯        | ä¸»æœºä¸åŒï¼ˆäºŒçº§åŸŸåä¸åŒï¼‰|


## Qï¼šå¦‚ä½•è·¨åŸŸ

### CORSï¼ˆè·¨åŸŸèµ„æºå…±äº«ï¼‰

> æ­¤æ–¹æ³•éœ€è¦å‰åç«¯é…åˆ

<a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Access_control_CORS">MDN å…³äºè·¨åŸŸèµ„æºå…±äº«çš„è§£é‡Š</a>

ç®€å•ç‚¹æ¥è¯´å°±æ˜¯å½“æœåŠ¡å™¨åœ¨è¿”å›å“åº”æ—¶ï¼Œåœ¨å…¶å“åº”æŠ¥æ–‡å¤´çš„ `Access-Control-Allow-Origin` ä¸­è¿”å›å…è®¸è®¿é—®çš„åŸŸï¼Œæˆ–è€…è¿”å› `*` è¡¨ç¤ºå…è®¸ä»»æ„å¤–åŸŸè®¿é—®ã€‚

è¯·æ±‚æŠ¥æ–‡
```
GET /resources/public-data/ HTTP/1.1
Host: bar.other
User-Agent: Mozilla/5.0 (Macintosh; U; Intel Mac OS X 10.5; en-US; rv:1.9.1b3pre) Gecko/20081130 Minefield/3.1b3pre
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: en-us,en;q=0.5
Accept-Encoding: gzip,deflate
Accept-Charset: ISO-8859-1,utf-8;q=0.7,*;q=0.7
Connection: keep-alive
Referer: http://foo.example/examples/access-control/simpleXSInvocation.html
Origin: http://foo.example
```
è¯·æ±‚æŠ¥æ–‡çš„ç¬¬10è¡Œï¼šOrigin: foo.example è¡¨æ˜è¯¥è¯·æ±‚æ¥æºäº foo.exmapleã€‚

å“åº”æŠ¥æ–‡
```
HTTP/1.1 200 OK
Date: Mon, 01 Dec 2008 00:23:53 GMT
Server: Apache/2.0.61 
Access-Control-Allow-Origin: *
Keep-Alive: timeout=2, max=100
Connection: Keep-Alive
Transfer-Encoding: chunked
Content-Type: application/xml
[XML Data]
```
å“åº”æŠ¥æ–‡çš„ç¬¬4è¡Œï¼šAccess-Control-Allow-Origin: * è¡¨æ˜è¯¥èµ„æºå¯ä»¥è¢«ä»»æ„å¤–åŸŸè®¿é—®ã€‚

### JSONPï¼ˆJSON with paddingï¼‰

> æ­¤æ–¹æ³•éœ€è¦å‰åç«¯é…åˆ

åŸç†ï¼šweb é¡µé¢ä¸Šè°ƒç”¨ js æ–‡ä»¶ä¸å—è·¨åŸŸå½±å“ï¼ˆCross-origin embeddingï¼‰ã€‚
å‰ç«¯åœ¨é¡µé¢ä¸Šè¯·æ±‚ js æ–‡ä»¶ï¼Œå¹¶åœ¨æŸ¥è¯¢å­—ç¬¦ä¸² `callback` ä¸­å¸¦ä¸Šæ–¹æ³•åã€‚

```html
<script src="http://localhost:3001?callback=myFunction"></script>
```
åç«¯è·å–åˆ°æ–¹æ³•åä¹‹åï¼Œè¿”å›ä¸€ä¸ªå‡½æ•°è°ƒç”¨ï¼Œå‡½æ•°çš„å‚æ•°å°±æ˜¯æˆ‘ä»¬æƒ³è¦çš„æ•°æ®ã€‚
```javascript
myFunction({'message': 'hello world from JSONP!ğŸ™ƒ'});
```

### postMessage

> é€‚ç”¨äºåŒä¸€é¡µé¢çš„ä¸åŒçª—ä½“ï¼ˆiframeï¼‰ã€‚
> è¯­æ³•ï¼šotherWindow.postMessage(message, targetOrigin, [transfer]);

> otherWindow
> å…¶ä»–çª—å£çš„ä¸€ä¸ªå¼•ç”¨ï¼Œæ¯”å¦‚ iframe çš„ contentWindow å±æ€§ã€æ‰§è¡Œ window.open è¿”å›çš„çª—å£å¯¹è±¡ã€æˆ–è€…æ˜¯å‘½åè¿‡æˆ–æ•°å€¼ç´¢å¼•çš„ window.framesã€‚

> message
> å°†è¦å‘é€åˆ°å…¶ä»– window çš„æ•°æ®ã€‚
> å®ƒå°†ä¼šè¢«ç»“æ„åŒ–å…‹éš†ç®—æ³•åºåˆ—åŒ–ã€‚è¿™æ„å‘³ç€ä½ å¯ä»¥ä¸å—ä»€ä¹ˆé™åˆ¶çš„å°†æ•°æ®å¯¹è±¡å®‰å…¨çš„ä¼ é€ç»™ç›®æ ‡çª—å£è€Œæ— éœ€è‡ªå·±åºåˆ—åŒ–ã€‚

> targetOrigin
> é€šè¿‡çª—å£çš„ origin å±æ€§æ¥æŒ‡å®šå“ªäº›çª—å£èƒ½æ¥æ”¶åˆ°æ¶ˆæ¯äº‹ä»¶ï¼Œå…¶å€¼å¯ä»¥æ˜¯å­—ç¬¦ä¸²" * "ï¼ˆè¡¨ç¤ºæ— é™åˆ¶ï¼‰æˆ–è€…ä¸€ä¸ª URIã€‚
> åœ¨å‘é€æ¶ˆæ¯çš„æ—¶å€™ï¼Œå¦‚æœç›®æ ‡çª—å£çš„åè®®ã€ä¸»æœºåœ°å€æˆ–ç«¯å£è¿™ä¸‰è€…çš„ä»»æ„ä¸€é¡¹ä¸åŒ¹é… targetOrigin æä¾›çš„å€¼ï¼Œé‚£ä¹ˆæ¶ˆæ¯å°±ä¸ä¼šè¢«å‘é€ï¼›
> åªæœ‰ä¸‰è€…å®Œå…¨åŒ¹é…ï¼Œæ¶ˆæ¯æ‰ä¼šè¢«å‘é€ã€‚è¿™ä¸ªæœºåˆ¶ç”¨æ¥æ§åˆ¶æ¶ˆæ¯å¯ä»¥å‘é€åˆ°å“ªäº›çª—å£ï¼›
> ä¾‹å¦‚ï¼Œå½“ç”¨ postMessage ä¼ é€å¯†ç æ—¶ï¼Œè¿™ä¸ªå‚æ•°å°±æ˜¾å¾—å°¤ä¸ºé‡è¦ï¼Œå¿…é¡»ä¿è¯å®ƒçš„å€¼ä¸è¿™æ¡åŒ…å«å¯†ç çš„ä¿¡æ¯çš„é¢„æœŸæ¥å—è€…çš„ origin å±æ€§å®Œå…¨ä¸€è‡´ï¼Œæ¥é˜²æ­¢å¯†ç è¢«æ¶æ„çš„ç¬¬ä¸‰æ–¹æˆªè·ã€‚å¦‚æœä½ æ˜ç¡®çš„çŸ¥é“æ¶ˆæ¯åº”è¯¥å‘é€åˆ°å“ªä¸ªçª—å£ï¼Œé‚£ä¹ˆè¯·å§‹ç»ˆæä¾›ä¸€ä¸ªæœ‰ç¡®åˆ‡å€¼çš„ targetOriginï¼Œè€Œä¸æ˜¯*ã€‚ä¸æä¾›ç¡®åˆ‡çš„ç›®æ ‡å°†å¯¼è‡´æ•°æ®æ³„éœ²åˆ°ä»»ä½•å¯¹æ•°æ®æ„Ÿå…´è¶£çš„æ¶æ„ç«™ç‚¹ã€‚

> *transfer å¯é€‰* 
> *æ˜¯ä¸€ä¸²å’Œ message åŒæ—¶ä¼ é€’çš„ Transferable å¯¹è±¡. è¿™äº›å¯¹è±¡çš„æ‰€æœ‰æƒå°†è¢«è½¬ç§»ç»™æ¶ˆæ¯çš„æ¥æ”¶æ–¹ï¼Œè€Œå‘é€ä¸€æ–¹å°†ä¸å†ä¿æœ‰æ‰€æœ‰æƒã€‚*

ä¾‹ï¼š

```html
<body>
<div id="father">
    <p>è¿™é‡Œ3000ç«¯å£</p>
    <input type="text"/>
    <button>å‘é€ä¿¡æ¯ç»™ 3001 ç«¯å£</button>
</div>
<iframe id="child" src="http://localhost:3001"></iframe>
```


```javascript
// ä» 3000 ç«¯å£å‘ 3001 ç«¯å£æ¨é€æ¶ˆæ¯
childFrame.postMessage('æ¶ˆæ¯å†…å®¹', 'http://localhost:3001');
```

```javascript
//ä» 3001 ç«¯å£æ¥æ”¶æ¶ˆæ¯
window.addEventListener('message', receiveMessage, false);

function receiveMessage (event) {
    if (event.origin !== 'http://localhost:3000') {
        return false
    }
    // ä» 3000 ç«¯å£å‘ 3001 ç«¯å£æ¨é€æ¶ˆæ¯
    parentWindow.postMessage('æˆ‘æ”¶åˆ°ä½ çš„æ¶ˆæ¯äº†', 'http://localhost:3000/');
}
```